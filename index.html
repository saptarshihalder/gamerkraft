<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamerKraft - Pro 2D Game Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; 
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        canvas {
            image-rendering: pixelated; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .tool-btn.active {
            background-color: #3b82f6; 
            color: white;
            border-color: #3b82f6;
        }
        
        .modal {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(4px);
        }

        .pattern-grid {
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #tutorial-overlay {
            z-index: 100;
            display: none;
        }
        
        .spotlight {
            position: absolute;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85); 
            border-radius: 6px;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 101;
            border: 2px solid #3b82f6;
        }

        .tutorial-card {
            position: absolute;
            z-index: 102;
            width: 300px;
            transition: all 0.4s ease;
        }

        body.exported-game #mainHeader,
        body.exported-game #sidebar,
        body.exported-game #tutorial-overlay,
        body.exported-game #modeControls, 
        body.exported-game #ioControls,
        body.exported-game #dialogModal { 
            display: none !important;
        }
        
        body.exported-game #workspace {
            padding: 0;
            background: #020617;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <header id="mainHeader" class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <i data-lucide="gamepad-2" class="text-blue-500 w-6 h-6"></i>
            <h1 class="font-bold text-lg tracking-tight">GamerKraft <span class="text-xs font-normal text-slate-500 bg-slate-800 px-2 py-0.5 rounded ml-2">v1.0</span></h1>
        </div>

        <div class="flex items-center gap-4">
            <div id="modeControls" class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                <button id="btnEdit" class="px-4 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-colors active">
                    <i data-lucide="pencil" class="w-4 h-4"></i> Editor
                </button>
                <button id="btnPlay" class="px-4 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-colors hover:text-white text-slate-400 hover:bg-slate-700">
                    <i data-lucide="play" class="w-4 h-4"></i> Play
                </button>
            </div>
            
            <div class="h-6 w-px bg-slate-700 mx-2"></div>

            <div id="ioControls" class="flex items-center gap-2">
                <button id="btnImport" onclick="document.getElementById('fileInput').click()" class="text-slate-400 hover:text-white transition-colors" title="Import JSON">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".json">

                <button id="btnExport" onclick="saveTheLevelToAJsonFile()" class="text-slate-400 hover:text-white transition-colors" title="Save Project">
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
                
                <button onclick="exportTheGameAsAStandaloneHtmlFile()" class="text-green-400 hover:text-green-300 transition-colors ml-2" title="Publish Standalone Game">
                    <i data-lucide="rocket" class="w-5 h-5"></i>
                </button>
                
                <div class="h-6 w-px bg-slate-700 mx-2"></div>

                <button onclick="deleteEverythingOnTheMap()" class="text-red-400 hover:text-red-300 transition-colors" title="Clear Map">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="h-6 w-px bg-slate-700 mx-2"></div>
            
            <button onclick="startTheTutorialThingy()" class="flex items-center gap-2 text-xs font-bold bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-full transition-colors">
                <i data-lucide="help-circle" class="w-3 h-3"></i> Help
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <aside id="sidebar" class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-10 overflow-y-auto">
            <div class="p-4" id="toolsSection">
                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Brushes</h3>
                <div class="grid grid-cols-2 gap-2" id="toolPalette">
                    
                </div>
            </div>

            <div class="p-4 border-t border-slate-800" id="settingsSection">
                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Settings</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-400">Grid</span>
                        <button id="toggleGrid" class="text-blue-400 font-mono text-xs">ON</button>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-400">Map Size</span>
                        <span class="text-slate-500 font-mono text-xs">40x25</span>
                    </div>
                </div>
            </div>

            <div class="mt-auto p-4 border-t border-slate-800 text-xs text-slate-600">
                <p>Left Click: Paint</p>
                <p>Right Click: Erase</p>
                <p>Play: Arrow Keys / WASD</p>
            </div>
        </aside>

        <main class="flex-1 bg-slate-950 pattern-grid relative overflow-auto flex items-center justify-center p-8 cursor-crosshair" id="workspace">
            <canvas id="gameCanvas" class="bg-slate-900 border border-slate-700"></canvas>
            
            <div id="gameOverlay" class="hidden absolute inset-0 modal flex items-center justify-center flex-col z-50">
                <h2 id="overlayTitle" class="text-4xl font-bold mb-2 text-white drop-shadow-lg">Game Over</h2>
                <p id="overlaySub" class="text-slate-300 mb-6">You hit a spike!</p>
                <button id="btnRestart" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-lg transition-transform hover:scale-105 flex items-center gap-2">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Try Again
                </button>
            </div>

            <div id="dialogModal" class="hidden absolute inset-0 modal flex items-center justify-center z-[60]">
                <div class="bg-slate-800 border border-slate-600 rounded-lg p-6 shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100">
                    <h3 id="dialogTitle" class="text-xl font-bold text-white mb-2">Confirm</h3>
                    <p id="dialogText" class="text-slate-300 mb-6 text-sm">Are you sure?</p>
                    <div class="flex justify-end gap-3">
                        <button id="dialogCancel" class="px-4 py-2 rounded text-slate-300 hover:bg-slate-700 transition-colors text-sm font-medium">Cancel</button>
                        <button id="dialogConfirm" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition-colors shadow-lg">Confirm</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="tutorial-overlay" class="absolute inset-0 w-full h-full pointer-events-auto">
        <div id="spotlight" class="spotlight"></div>
        <div id="tutorialCard" class="tutorial-card bg-slate-800 border border-slate-600 rounded-lg p-5 shadow-2xl">
            <div class="flex justify-between items-start mb-3">
                <h3 id="tutTitle" class="font-bold text-white text-lg">Welcome</h3>
                <span id="tutStep" class="text-xs text-slate-500 font-mono bg-slate-900 px-2 py-0.5 rounded">1/5</span>
            </div>
            <p id="tutText" class="text-slate-300 text-sm mb-4 leading-relaxed">Description goes here.</p>
            <div class="flex justify-between items-center">
                <button onclick="endTheTutorialThingy()" class="text-slate-500 hover:text-slate-300 text-xs font-medium">Skip</button>
                <button onclick="goToTheNextStepInTutorial()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors">Next</button>
            </div>
        </div>
    </div>

    <script>
        // this is the size of the square thingy
        const theSizeOfOneSingleSquareBlockThingy = 32;
        // this is how wide the map is in blocks
        const theTotalNumberOfBlocksGoingLeftToRight = 40;
        // this is how tall the map is in blocks
        const theTotalNumberOfBlocksGoingTopToBottom = 25;
        
        // just a list of numbers i guess
        const aListThatTellsUsWhatNumberMeansWhatBlock = {
            NOTHING: 0,
            GROUND_BLOCK: 1,
            THE_DUDE: 2,
            MONEY_THING: 3,
            OUCHY_SPIKE: 4,
            WINNER_FLAG: 5,
            FLOATY_BLOCK: 6
        };

        // pretty colors and icons and stuff
        const theVisualInformationForTheBlocksLikeColorAndIcon = {
            [aListThatTellsUsWhatNumberMeansWhatBlock.NOTHING]: { name: 'Eraser', color: null, icon: 'eraser' },
            [aListThatTellsUsWhatNumberMeansWhatBlock.GROUND_BLOCK]: { name: 'Ground', color: '#475569', icon: 'square' },
            [aListThatTellsUsWhatNumberMeansWhatBlock.FLOATY_BLOCK]: { name: 'Platform', color: '#64748b', icon: 'minus' },
            [aListThatTellsUsWhatNumberMeansWhatBlock.THE_DUDE]: { name: 'Start', color: '#3b82f6', icon: 'user' },
            [aListThatTellsUsWhatNumberMeansWhatBlock.MONEY_THING]: { name: 'Coin', color: '#fbbf24', icon: 'circle-dollar-sign' },
            [aListThatTellsUsWhatNumberMeansWhatBlock.OUCHY_SPIKE]: { name: 'Spike', color: '#ef4444', icon: 'triangle' },
            [aListThatTellsUsWhatNumberMeansWhatBlock.WINNER_FLAG]: { name: 'Goal', color: '#22c55e', icon: 'flag' }
        };

        // this holds all the stuff that changes
        const thisVariableHoldsEverythingThatIsHappeningRightNow = {
            whatModeAreWeIn: 'EDIT', 
            theMapDataArrayWithNumbers: new Array(theTotalNumberOfBlocksGoingLeftToRight * theTotalNumberOfBlocksGoingTopToBottom).fill(0),
            theBlockWeAreCurrentlyUsingToPaint: aListThatTellsUsWhatNumberMeansWhatBlock.GROUND_BLOCK,
            isTheGridLinesVisibleOrNot: true,
            isTheMouseCurrentlyBeingPressedDown: false,
            isTheMouseRightClicked: false,
            whereIsTheCameraLooking: { x: 0, y: 0 }
        };

        // all the game logic happens here i think
        let allTheGameLogicStuffIsStoredInHereIDKWhy = {
            isTheGameRunning: false,
            theLittleGuyYouControl: { x: 0, y: 0, vx: 0, vy: 0, isHeOnTheGround: false, isHeDead: false, didHeWin: false },
            theMoneyThingsYouCanCollect: [],
            theExplosionParticles: [],
            howManyPointsYouHave: 0
        };

        // grabbing the elements from the html page
        const theHTMLCanvasElementThatWeDrawOn = document.getElementById('gameCanvas');
        const theContextThingyNormallyCalledCtxButImChangingIt = theHTMLCanvasElementThatWeDrawOn.getContext('2d');
        const theDivContainerThatHoldsTheCanvas = document.getElementById('workspace');

        // lets get this party started
        function startTheWholeFreakingEngine() {
            // checking if we downloaded this game or not
            if (window.EXPORTED_GAME_DATA) {
                // putting the map data in the thing
                thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers = window.EXPORTED_GAME_DATA.map;
                
                // hiding the buttons and stuff
                document.body.classList.add('exported-game');
                
                // start playing right away
                thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn = 'PLAY';
                // wait a bit for no reason
                setTimeout(() => {
                    prepareTheGameVariablesBeforeStarting();
                    // fixing the size
                    window.addEventListener('resize', fixTheCanvasSizeForExportedGames);
                    fixTheCanvasSizeForExportedGames();
                }, 100);
            } else {
                // editor mode stuff
                theHTMLCanvasElementThatWeDrawOn.width = theTotalNumberOfBlocksGoingLeftToRight * theSizeOfOneSingleSquareBlockThingy;
                theHTMLCanvasElementThatWeDrawOn.height = theTotalNumberOfBlocksGoingTopToBottom * theSizeOfOneSingleSquareBlockThingy;
                makeTheButtonsLookNiceInTheSidebar();
            }

            // making icons appear
            if(typeof lucide !== 'undefined') lucide.createIcons();

            listenForClicksAndKeyboardPresses();
            
            // start the loopty loop
            requestAnimationFrame(theMainLoopThatRunsSixtyTimesASecond);
        }
        
        // this shit makes it center on screen
        function fixTheCanvasSizeForExportedGames() {
            if (!window.EXPORTED_GAME_DATA) return;
            // centering it
            theHTMLCanvasElementThatWeDrawOn.style.marginTop = 'auto';
            theHTMLCanvasElementThatWeDrawOn.style.marginBottom = 'auto';
        }

        // buttons go brrr
        function makeTheButtonsLookNiceInTheSidebar() {
            const container = document.getElementById('toolPalette');
            if(!container) return;
            container.innerHTML = '';

            Object.keys(theVisualInformationForTheBlocksLikeColorAndIcon).forEach(key => {
                const id = parseInt(key);
                const def = theVisualInformationForTheBlocksLikeColorAndIcon[id];
                if (!def) return;

                const btn = document.createElement('button');
                btn.className = `tool-btn p-3 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700 flex flex-col items-center gap-2 transition-all ${id === thisVariableHoldsEverythingThatIsHappeningRightNow.theBlockWeAreCurrentlyUsingToPaint ? 'active ring-2 ring-blue-500 ring-offset-1 ring-offset-slate-900' : ''}`;
                btn.onclick = () => pickTheToolYouWantToUse(id);
                
                // svg garbage
                let iconSvg = '';
                if(def.icon === 'square') iconSvg = '<rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor"/>';
                else if(def.icon === 'user') iconSvg = '<circle cx="12" cy="8" r="4" fill="currentColor"/><path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" fill="currentColor"/>';
                else if(def.icon === 'triangle') iconSvg = '<path d="M12 4L4 20h16L12 4z" fill="currentColor"/>';
                else if(def.icon === 'circle-dollar-sign') iconSvg = '<circle cx="12" cy="12" r="8" stroke="currentColor" fill="none" stroke-width="2"/><path d="M12 8v8" stroke="currentColor" stroke-width="2"/>';
                else if(def.icon === 'flag') iconSvg = '<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" fill="currentColor"/><line x1="4" y1="22" x2="4" y2="15" stroke="currentColor" stroke-width="2"/>';
                else if(def.icon === 'minus') iconSvg = '<rect x="4" y="10" width="16" height="4" rx="1" fill="currentColor"/>';
                else iconSvg = '<path d="M18 13l-5-5-5 5M13 8l5 5 5-5" stroke="currentColor" fill="none" stroke-width="2"/>'; 

                btn.innerHTML = `
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">${iconSvg}</svg>
                    <span class="text-xs font-medium">${def.name}</span>
                `;
                container.appendChild(btn);
            });
        }

        // picking the tool
        function pickTheToolYouWantToUse(id) {
            thisVariableHoldsEverythingThatIsHappeningRightNow.theBlockWeAreCurrentlyUsingToPaint = id;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            // do it again
            makeTheButtonsLookNiceInTheSidebar();
        }

        // listening for things
        function listenForClicksAndKeyboardPresses() {
            // mouse clicky
            theHTMLCanvasElementThatWeDrawOn.addEventListener('mousedown', (e) => {
                thisVariableHoldsEverythingThatIsHappeningRightNow.isTheMouseCurrentlyBeingPressedDown = true;
                thisVariableHoldsEverythingThatIsHappeningRightNow.isTheMouseRightClicked = e.button === 2;
                drawTheBlockOnTheScreenWhenClicked(e);
            });
            window.addEventListener('mouseup', () => thisVariableHoldsEverythingThatIsHappeningRightNow.isTheMouseCurrentlyBeingPressedDown = false);
            theHTMLCanvasElementThatWeDrawOn.addEventListener('mousemove', (e) => {
                if(thisVariableHoldsEverythingThatIsHappeningRightNow.isTheMouseCurrentlyBeingPressedDown) drawTheBlockOnTheScreenWhenClicked(e);
            });
            theHTMLCanvasElementThatWeDrawOn.addEventListener('contextmenu', e => e.preventDefault());

            // button clicky
            const btnEdit = document.getElementById('btnEdit');
            if(btnEdit) btnEdit.addEventListener('click', () => switchBetweenEditingAndPlayingTheGame('EDIT'));
            
            const btnPlay = document.getElementById('btnPlay');
            if(btnPlay) btnPlay.addEventListener('click', () => switchBetweenEditingAndPlayingTheGame('PLAY'));
            
            const btnGrid = document.getElementById('toggleGrid');
            if(btnGrid) btnGrid.addEventListener('click', turnTheGridLinesOnOrOff);
            
            const btnRestart = document.getElementById('btnRestart');
            if(btnRestart) btnRestart.addEventListener('click', startOverBecauseYouProbablyDied);

            // file stuff
            const fInput = document.getElementById('fileInput');
            if(fInput) fInput.addEventListener('change', loadTheLevelFromAJsonFile);

            // key smash
            window.addEventListener('keydown', checkIfTheUserIsPressingKeys);
            window.addEventListener('keyup', checkIfTheUserStoppedPressingKeys);
            window.addEventListener('resize', () => {
                if(isTheTutorialThingActiveOrNot) endTheTutorialThingy(); 
            });
        }

        // drawing blocks
        function drawTheBlockOnTheScreenWhenClicked(e) {
            if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn !== 'EDIT') return;
            const rect = theHTMLCanvasElementThatWeDrawOn.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / theSizeOfOneSingleSquareBlockThingy);
            const y = Math.floor((e.clientY - rect.top) / theSizeOfOneSingleSquareBlockThingy);

            if (x < 0 || x >= theTotalNumberOfBlocksGoingLeftToRight || y < 0 || y >= theTotalNumberOfBlocksGoingTopToBottom) return;

            const idx = y * theTotalNumberOfBlocksGoingLeftToRight + x;
            const tileToSet = thisVariableHoldsEverythingThatIsHappeningRightNow.isTheMouseRightClicked ? aListThatTellsUsWhatNumberMeansWhatBlock.NOTHING : thisVariableHoldsEverythingThatIsHappeningRightNow.theBlockWeAreCurrentlyUsingToPaint;

            // only one player allowed otherwise game go boom
            if (tileToSet === aListThatTellsUsWhatNumberMeansWhatBlock.THE_DUDE) {
                const existingPlayer = thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers.indexOf(aListThatTellsUsWhatNumberMeansWhatBlock.THE_DUDE);
                if (existingPlayer !== -1) thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers[existingPlayer] = aListThatTellsUsWhatNumberMeansWhatBlock.NOTHING;
            }

            thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers[idx] = tileToSet;
        }

        // switching modes
        function switchBetweenEditingAndPlayingTheGame(mode) {
            thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn = mode;
            const btnEdit = document.getElementById('btnEdit');
            const btnPlay = document.getElementById('btnPlay');
            const overlay = document.getElementById('gameOverlay');

            if (mode === 'PLAY') {
                if(btnEdit) {
                    btnEdit.classList.remove('active', 'bg-blue-600', 'text-white');
                    btnEdit.classList.add('text-slate-400');
                }
                if(btnPlay) {
                    btnPlay.classList.add('active', 'bg-blue-600', 'text-white');
                    btnPlay.classList.remove('text-slate-400');
                }
                
                prepareTheGameVariablesBeforeStarting();
                theDivContainerThatHoldsTheCanvas.style.cursor = 'default';
            } else {
                if(btnPlay) {
                    btnPlay.classList.remove('active', 'bg-blue-600', 'text-white');
                    btnPlay.classList.add('text-slate-400');
                }
                if(btnEdit) {
                    btnEdit.classList.add('active', 'bg-blue-600', 'text-white');
                    btnEdit.classList.remove('text-slate-400');
                }
                
                overlay.classList.add('hidden');
                theDivContainerThatHoldsTheCanvas.style.cursor = 'crosshair';
            }
        }

        // grid toggle
        function turnTheGridLinesOnOrOff() {
            thisVariableHoldsEverythingThatIsHappeningRightNow.isTheGridLinesVisibleOrNot = !thisVariableHoldsEverythingThatIsHappeningRightNow.isTheGridLinesVisibleOrNot;
            document.getElementById('toggleGrid').innerText = thisVariableHoldsEverythingThatIsHappeningRightNow.isTheGridLinesVisibleOrNot ? "ON" : "OFF";
        }

        // keys object
        const KEYS = { left: false, right: false, up: false };

        // key down
        function checkIfTheUserIsPressingKeys(e) {
            if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn !== 'PLAY') return;
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') KEYS.left = true;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') KEYS.right = true;
            if (e.code === 'ArrowUp' || e.code === 'KeyW' || e.code === 'Space') {
                if(!KEYS.up && allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.isHeOnTheGround && !allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.isHeDead && !allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.didHeWin) {
                    allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.vy = -13; 
                    allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.isHeOnTheGround = false;
                }
                KEYS.up = true;
            }
            if (e.code === 'KeyR') startOverBecauseYouProbablyDied();
        }

        // key up
        function checkIfTheUserStoppedPressingKeys(e) {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') KEYS.left = false;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') KEYS.right = false;
            if (e.code === 'ArrowUp' || e.code === 'KeyW' || e.code === 'Space') KEYS.up = false;
        }

        // making the game ready
        function prepareTheGameVariablesBeforeStarting() {
            // find start
            let startIdx = thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers.indexOf(aListThatTellsUsWhatNumberMeansWhatBlock.THE_DUDE);
            if (startIdx === -1) startIdx = 0; 

            const startX = (startIdx % theTotalNumberOfBlocksGoingLeftToRight) * theSizeOfOneSingleSquareBlockThingy;
            const startY = Math.floor(startIdx / theTotalNumberOfBlocksGoingLeftToRight) * theSizeOfOneSingleSquareBlockThingy;

            allTheGameLogicStuffIsStoredInHereIDKWhy = {
                isTheGameRunning: true,
                theLittleGuyYouControl: { 
                    x: startX, 
                    y: startY, 
                    w: 24, h: 24, 
                    vx: 0, vy: 0, 
                    isHeOnTheGround: false,
                    isHeDead: false,
                    didHeWin: false
                },
                theMoneyThingsYouCanCollect: [],
                theExplosionParticles: [],
                howManyPointsYouHave: 0
            };

            // adding money
            thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers.forEach((t, i) => {
                if (t === aListThatTellsUsWhatNumberMeansWhatBlock.MONEY_THING) {
                    allTheGameLogicStuffIsStoredInHereIDKWhy.theMoneyThingsYouCanCollect.push({ 
                        x: (i % theTotalNumberOfBlocksGoingLeftToRight) * theSizeOfOneSingleSquareBlockThingy + 8, 
                        y: Math.floor(i / theTotalNumberOfBlocksGoingLeftToRight) * theSizeOfOneSingleSquareBlockThingy + 8,
                        collected: false,
                        bobOffset: Math.random() * Math.PI * 2
                    });
                }
            });

            document.getElementById('gameOverlay').classList.add('hidden');
        }

        // reset
        function startOverBecauseYouProbablyDied() {
            prepareTheGameVariablesBeforeStarting();
        }

        // physics and stuff
        function calculatePhysicsAndMovementStuff() {
            if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn !== 'PLAY' || !allTheGameLogicStuffIsStoredInHereIDKWhy.isTheGameRunning || allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.isHeDead || allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.didHeWin) return;

            const p = allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl;

            // move left right
            if (KEYS.left) p.vx = -5;
            else if (KEYS.right) p.vx = 5;
            else p.vx *= 0.8; 

            // gravity hurts
            p.vy += 0.6; 
            if(p.vy > 12) p.vy = 12; 

            // move
            p.x += p.vx;
            stopThePlayerFromGoingThroughWalls(p, 'x');
            p.y += p.vy;
            stopThePlayerFromGoingThroughWalls(p, 'y');

            // void check
            if (p.y > theHTMLCanvasElementThatWeDrawOn.height) killThePlayerAndShowGameOver("You fell into the void!");

            // check stuff
            seeIfWeTouchedACoinOrSpike();

            // particles go boom
            allTheGameLogicStuffIsStoredInHereIDKWhy.theExplosionParticles.forEach((pt, i) => {
                pt.x += pt.vx;
                pt.y += pt.vy;
                pt.life--;
                if(pt.life <= 0) allTheGameLogicStuffIsStoredInHereIDKWhy.theExplosionParticles.splice(i, 1);
            });
        }

        // bonk
        function stopThePlayerFromGoingThroughWalls(p, axis) {
            // math stuff i copied
            const left = Math.floor(p.x / theSizeOfOneSingleSquareBlockThingy);
            const right = Math.floor((p.x + p.w) / theSizeOfOneSingleSquareBlockThingy);
            const top = Math.floor(p.y / theSizeOfOneSingleSquareBlockThingy);
            const bottom = Math.floor((p.y + p.h) / theSizeOfOneSingleSquareBlockThingy);

            const tilesToCheck = [];
            for(let y = top; y <= bottom; y++) {
                for(let x = left; x <= right; x++) {
                    if (x < 0 || x >= theTotalNumberOfBlocksGoingLeftToRight || y < 0 || y >= theTotalNumberOfBlocksGoingTopToBottom) continue;
                    const type = thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers[y * theTotalNumberOfBlocksGoingLeftToRight + x];
                    if (type === aListThatTellsUsWhatNumberMeansWhatBlock.GROUND_BLOCK || type === aListThatTellsUsWhatNumberMeansWhatBlock.FLOATY_BLOCK) {
                        tilesToCheck.push({x: x * theSizeOfOneSingleSquareBlockThingy, y: y * theSizeOfOneSingleSquareBlockThingy, type});
                    }
                }
            }

            for (let tile of tilesToCheck) {
                // collision maths
                if (p.x < tile.x + theSizeOfOneSingleSquareBlockThingy && p.x + p.w > tile.x &&
                    p.y < tile.y + theSizeOfOneSingleSquareBlockThingy && p.y + p.h > tile.y) {
                    
                    if (axis === 'x') {
                        if (p.vx > 0) p.x = tile.x - p.w;
                        if (p.vx < 0) p.x = tile.x + theSizeOfOneSingleSquareBlockThingy;
                        p.vx = 0;
                    } else {
                        if (p.vy > 0) { 
                             if (tile.type === aListThatTellsUsWhatNumberMeansWhatBlock.FLOATY_BLOCK && (p.y - p.vy) + p.h > tile.y) return;

                            p.y = tile.y - p.h;
                            p.isHeOnTheGround = true;
                            p.vy = 0;
                        } else if (p.vy < 0 && tile.type !== aListThatTellsUsWhatNumberMeansWhatBlock.FLOATY_BLOCK) { 
                            p.y = tile.y + theSizeOfOneSingleSquareBlockThingy;
                            p.vy = 0;
                        }
                    }
                }
            }
        }

        // touching things
        function seeIfWeTouchedACoinOrSpike() {
            const p = allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl;
            const cx = p.x + p.w/2;
            const cy = p.y + p.h/2;

            const tx = Math.floor(cx / theSizeOfOneSingleSquareBlockThingy);
            const ty = Math.floor(cy / theSizeOfOneSingleSquareBlockThingy);
            const idx = ty * theTotalNumberOfBlocksGoingLeftToRight + tx;
            const tile = thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers[idx];

            if (tile === aListThatTellsUsWhatNumberMeansWhatBlock.OUCHY_SPIKE) {
                // ouch
                if (cy > ty * theSizeOfOneSingleSquareBlockThingy + 16) killThePlayerAndShowGameOver("Spiked!");
            } else if (tile === aListThatTellsUsWhatNumberMeansWhatBlock.WINNER_FLAG) {
                showTheVictoryScreenBecauseYouWon();
            }

            // money money
            allTheGameLogicStuffIsStoredInHereIDKWhy.theMoneyThingsYouCanCollect.forEach(c => {
                if (c.collected) return;
                const dx = cx - c.x - 8; 
                const dy = cy - c.y - 8;
                if (Math.sqrt(dx*dx + dy*dy) < 16) {
                    c.collected = true;
                    allTheGameLogicStuffIsStoredInHereIDKWhy.howManyPointsYouHave += 100;
                    makeExplosionParticles(c.x + 8, c.y + 8, '#fbbf24');
                }
            });
        }

        // you dead
        function killThePlayerAndShowGameOver(reason) {
            allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.isHeDead = true;
            displayAPopupBoxThingy('Game Over', reason, false);
            makeExplosionParticles(allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.x + 12, allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.y + 12, '#ef4444', 20);
        }

        // you win
        function showTheVictoryScreenBecauseYouWon() {
            allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.didHeWin = true;
            displayAPopupBoxThingy('Victory!', `Score: ${allTheGameLogicStuffIsStoredInHereIDKWhy.howManyPointsYouHave}`, true);
            makeExplosionParticles(allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.x + 12, allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl.y + 12, '#22c55e', 50);
        }

        // show box
        function displayAPopupBoxThingy(title, sub, isWin) {
            document.getElementById('overlayTitle').innerText = title;
            document.getElementById('overlayTitle').className = isWin ? "text-4xl font-bold mb-2 text-green-400 drop-shadow-lg" : "text-4xl font-bold mb-2 text-red-400 drop-shadow-lg";
            document.getElementById('overlaySub').innerText = sub;
            document.getElementById('gameOverlay').classList.remove('hidden');
        }

        // boom
        function makeExplosionParticles(x, y, color, count=10) {
            for(let i=0; i<count; i++) {
                allTheGameLogicStuffIsStoredInHereIDKWhy.theExplosionParticles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: 30 + Math.random() * 20,
                    color: color
                });
            }
        }

        // this shit keeps running
        function theMainLoopThatRunsSixtyTimesASecond() {
            calculatePhysicsAndMovementStuff();
            actuallyDrawEverythingOnTheCanvasNow();
            requestAnimationFrame(theMainLoopThatRunsSixtyTimesASecond);
        }

        // paint stuff
        function actuallyDrawEverythingOnTheCanvasNow() {
            // clearing the thing
            theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#020617'; 
            theContextThingyNormallyCalledCtxButImChangingIt.fillRect(0, 0, theHTMLCanvasElementThatWeDrawOn.width, theHTMLCanvasElementThatWeDrawOn.height);

            // lines
            if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn === 'EDIT' && thisVariableHoldsEverythingThatIsHappeningRightNow.isTheGridLinesVisibleOrNot) {
                theContextThingyNormallyCalledCtxButImChangingIt.strokeStyle = '#1e293b';
                theContextThingyNormallyCalledCtxButImChangingIt.lineWidth = 1;
                theContextThingyNormallyCalledCtxButImChangingIt.beginPath();
                for (let x = 0; x <= theHTMLCanvasElementThatWeDrawOn.width; x += theSizeOfOneSingleSquareBlockThingy) { theContextThingyNormallyCalledCtxButImChangingIt.moveTo(x, 0); theContextThingyNormallyCalledCtxButImChangingIt.lineTo(x, theHTMLCanvasElementThatWeDrawOn.height); }
                for (let y = 0; y <= theHTMLCanvasElementThatWeDrawOn.height; y += theSizeOfOneSingleSquareBlockThingy) { theContextThingyNormallyCalledCtxButImChangingIt.moveTo(0, y); theContextThingyNormallyCalledCtxButImChangingIt.lineTo(theHTMLCanvasElementThatWeDrawOn.width, y); }
                theContextThingyNormallyCalledCtxButImChangingIt.stroke();
            }

            // drawing all the blocks one by one
            for (let y = 0; y < theTotalNumberOfBlocksGoingTopToBottom; y++) {
                for (let x = 0; x < theTotalNumberOfBlocksGoingLeftToRight; x++) {
                    const idx = y * theTotalNumberOfBlocksGoingLeftToRight + x;
                    const type = thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers[idx];
                    const px = x * theSizeOfOneSingleSquareBlockThingy;
                    const py = y * theSizeOfOneSingleSquareBlockThingy;

                    if (type === aListThatTellsUsWhatNumberMeansWhatBlock.NOTHING) continue;

                    if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn === 'PLAY') {
                         if (type === aListThatTellsUsWhatNumberMeansWhatBlock.THE_DUDE) continue; 
                         if (type === aListThatTellsUsWhatNumberMeansWhatBlock.MONEY_THING) continue; 
                    }

                    if (type === aListThatTellsUsWhatNumberMeansWhatBlock.GROUND_BLOCK) {
                        theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#334155';
                        theContextThingyNormallyCalledCtxButImChangingIt.fillRect(px, py, theSizeOfOneSingleSquareBlockThingy, theSizeOfOneSingleSquareBlockThingy);
                        theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#475569';
                        theContextThingyNormallyCalledCtxButImChangingIt.fillRect(px, py, theSizeOfOneSingleSquareBlockThingy, 4);
                    } else if (type === aListThatTellsUsWhatNumberMeansWhatBlock.FLOATY_BLOCK) {
                         theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#64748b';
                         theContextThingyNormallyCalledCtxButImChangingIt.fillRect(px, py, theSizeOfOneSingleSquareBlockThingy, 8);
                    } else if (type === aListThatTellsUsWhatNumberMeansWhatBlock.THE_DUDE) {
                        theContextThingyNormallyCalledCtxButImChangingIt.strokeStyle = '#3b82f6';
                        theContextThingyNormallyCalledCtxButImChangingIt.lineWidth = 2;
                        theContextThingyNormallyCalledCtxButImChangingIt.strokeRect(px+4, py+4, theSizeOfOneSingleSquareBlockThingy-8, theSizeOfOneSingleSquareBlockThingy-8);
                        theContextThingyNormallyCalledCtxButImChangingIt.font = '10px monospace';
                        theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#3b82f6';
                        theContextThingyNormallyCalledCtxButImChangingIt.fillText('START', px+2, py+20);
                    } else if (type === aListThatTellsUsWhatNumberMeansWhatBlock.MONEY_THING) {
                        theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#fbbf24';
                        theContextThingyNormallyCalledCtxButImChangingIt.beginPath();
                        theContextThingyNormallyCalledCtxButImChangingIt.arc(px + 16, py + 16, 8, 0, Math.PI * 2);
                        theContextThingyNormallyCalledCtxButImChangingIt.fill();
                    } else if (type === aListThatTellsUsWhatNumberMeansWhatBlock.OUCHY_SPIKE) {
                        theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#ef4444';
                        theContextThingyNormallyCalledCtxButImChangingIt.beginPath();
                        theContextThingyNormallyCalledCtxButImChangingIt.moveTo(px, py + theSizeOfOneSingleSquareBlockThingy);
                        theContextThingyNormallyCalledCtxButImChangingIt.lineTo(px + theSizeOfOneSingleSquareBlockThingy / 2, py);
                        theContextThingyNormallyCalledCtxButImChangingIt.lineTo(px + theSizeOfOneSingleSquareBlockThingy, py + theSizeOfOneSingleSquareBlockThingy);
                        theContextThingyNormallyCalledCtxButImChangingIt.fill();
                    } else if (type === aListThatTellsUsWhatNumberMeansWhatBlock.WINNER_FLAG) {
                        theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#22c55e';
                        theContextThingyNormallyCalledCtxButImChangingIt.fillRect(px + 10, py + 4, 4, 28);
                        theContextThingyNormallyCalledCtxButImChangingIt.beginPath();
                        theContextThingyNormallyCalledCtxButImChangingIt.moveTo(px + 14, py + 4);
                        theContextThingyNormallyCalledCtxButImChangingIt.lineTo(px + 28, py + 10);
                        theContextThingyNormallyCalledCtxButImChangingIt.lineTo(px + 14, py + 16);
                        theContextThingyNormallyCalledCtxButImChangingIt.fill();
                    }
                }
            }

            // draw play stuff
            if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn === 'PLAY' && allTheGameLogicStuffIsStoredInHereIDKWhy.isTheGameRunning) {
                // coins
                allTheGameLogicStuffIsStoredInHereIDKWhy.theMoneyThingsYouCanCollect.forEach(c => {
                    if (c.collected) return;
                    const bob = Math.sin(Date.now() / 200 + c.bobOffset) * 3;
                    theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#fbbf24';
                    theContextThingyNormallyCalledCtxButImChangingIt.shadowColor = '#fbbf24';
                    theContextThingyNormallyCalledCtxButImChangingIt.shadowBlur = 10;
                    theContextThingyNormallyCalledCtxButImChangingIt.beginPath();
                    theContextThingyNormallyCalledCtxButImChangingIt.arc(c.x, c.y + bob, 6, 0, Math.PI * 2);
                    theContextThingyNormallyCalledCtxButImChangingIt.fill();
                    theContextThingyNormallyCalledCtxButImChangingIt.shadowBlur = 0;
                });

                // player
                const p = allTheGameLogicStuffIsStoredInHereIDKWhy.theLittleGuyYouControl;
                if (!p.isHeDead && !p.didHeWin) {
                    theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = '#3b82f6';
                    // wobbly logic
                    let w = p.w;
                    let h = p.h;
                    let offX = 0;
                    let offY = 0;
                    
                    if (!p.isHeOnTheGround) { h = p.h + 4; w = p.w - 4; offX = 2; offY = -2; }
                    else if (Math.abs(p.vx) > 0.1) {
                         const wobble = Math.sin(Date.now() / 50) * 2;
                         h = p.h - Math.abs(wobble);
                         w = p.w + Math.abs(wobble);
                         offY = Math.abs(wobble);
                         offX = -Math.abs(wobble)/2;
                    }

                    theContextThingyNormallyCalledCtxButImChangingIt.fillRect(p.x + offX, p.y + offY, w, h);
                    
                    // eyeballs
                    theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = 'white';
                    const dir = KEYS.left ? -1 : 1;
                    theContextThingyNormallyCalledCtxButImChangingIt.fillRect(p.x + offX + (dir === 1 ? 14 : 4), p.y + offY + 4, 4, 4);
                }

                // particles
                allTheGameLogicStuffIsStoredInHereIDKWhy.theExplosionParticles.forEach(pt => {
                    theContextThingyNormallyCalledCtxButImChangingIt.globalAlpha = pt.life / 30;
                    theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = pt.color;
                    theContextThingyNormallyCalledCtxButImChangingIt.fillRect(pt.x, pt.y, 4, 4);
                    theContextThingyNormallyCalledCtxButImChangingIt.globalAlpha = 1;
                });

                // score text
                theContextThingyNormallyCalledCtxButImChangingIt.fillStyle = 'white';
                theContextThingyNormallyCalledCtxButImChangingIt.font = 'bold 16px sans-serif';
                theContextThingyNormallyCalledCtxButImChangingIt.fillText(`SCORE: ${allTheGameLogicStuffIsStoredInHereIDKWhy.howManyPointsYouHave}`, 20, 30);
            }
        }

        // save it
        function saveTheLevelToAJsonFile() {
            const data = {
                version: 1,
                date: new Date().toISOString(),
                map: thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers,
                width: theTotalNumberOfBlocksGoingLeftToRight,
                height: theTotalNumberOfBlocksGoingTopToBottom
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-gamerkraft-level.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // load it
        function loadTheLevelFromAJsonFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.map && data.map.length === theTotalNumberOfBlocksGoingLeftToRight * theTotalNumberOfBlocksGoingTopToBottom) {
                        thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers = data.map;
                        // reset if needed
                        if (thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn === 'PLAY') switchBetweenEditingAndPlayingTheGame('EDIT');
                        displayAPopupBoxThingy('Success', 'Level loaded successfully!', false);
                    } else {
                        displayAPopupBoxThingy('Error', 'Invalid level format or dimensions.', false);
                    }
                } catch (err) {
                    displayAPopupBoxThingy('Error', 'Error reading file.', false);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        }

        // publish it
        function exportTheGameAsAStandaloneHtmlFile() {
            displayAPopupBoxThingy('Publish Game', 'Download a standalone HTML file? This file will contain your game engine and level, ready to play in any browser.', true, () => {
                // wait for box to close
                setTimeout(() => {
                    let source = document.documentElement.outerHTML;
                    // injecting the map stuff
                    const injection = `<script>window.EXPORTED_GAME_DATA = { map: ${JSON.stringify(thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers)} };<\/script>`;
                    source = source.replace('</head>', `${injection}</head>`);
                    
                    const blob = new Blob([source], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'my-published-game.html';
                    a.click();
                    URL.revokeObjectURL(url);
                }, 100);
            });
        }

        // delete it
        function deleteEverythingOnTheMap() {
            displayAPopupBoxThingy('Clear Map', 'Are you sure you want to delete everything? This cannot be undone.', true, () => {
                thisVariableHoldsEverythingThatIsHappeningRightNow.theMapDataArrayWithNumbers.fill(0);
                if(thisVariableHoldsEverythingThatIsHappeningRightNow.whatModeAreWeIn === 'PLAY') switchBetweenEditingAndPlayingTheGame('EDIT');
            });
        }

        // show the box
        function displayAPopupBoxThingy(title, text, isConfirm, onConfirm) {
            const el = document.getElementById('dialogModal');
            document.getElementById('dialogTitle').innerText = title;
            document.getElementById('dialogText').innerText = text;
            
            const btnConfirm = document.getElementById('dialogConfirm');
            const btnCancel = document.getElementById('dialogCancel');

            // clone remove listeners
            const newConfirm = btnConfirm.cloneNode(true);
            const newCancel = btnCancel.cloneNode(true);
            btnConfirm.parentNode.replaceChild(newConfirm, btnConfirm);
            btnCancel.parentNode.replaceChild(newCancel, btnCancel);

            if (isConfirm) {
                newConfirm.innerText = 'Confirm';
                newConfirm.className = "px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white text-sm font-medium transition-colors shadow-lg";
                newCancel.classList.remove('hidden');
                
                newConfirm.onclick = () => {
                    if (onConfirm) onConfirm();
                    el.classList.add('hidden');
                };
            } else {
                newConfirm.innerText = 'OK';
                newConfirm.className = "px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition-colors shadow-lg";
                newCancel.classList.add('hidden');
                
                newConfirm.onclick = () => {
                    el.classList.add('hidden');
                };
            }

            newCancel.onclick = () => {
                el.classList.add('hidden');
            };

            el.classList.remove('hidden');
        }

        // tutorial stuff
        let currentStepInTheTutorialThingy = 0;
        let isTheTutorialThingActiveOrNot = false;

        const tutorialSteps = [
            { target: '#mainHeader', title: 'Welcome to GamerKraft', msg: 'Your professional 2D game engine. Let\'s take a quick tour of the interface!', pos: 'bottom' },
            { target: '#modeControls', title: 'Game Modes', msg: 'Switch between "Editor" to build your world and "Play" to test it instantly.', pos: 'bottom' },
            { target: '#toolsSection', title: 'Tool Palette', msg: 'Select brushes here. Use Ground for walls, Player for spawn points, and Spikes for hazards.', pos: 'right' },
            { target: '#workspace', title: 'The Canvas', msg: 'This is your world. Left-click to paint, Right-click to erase tiles.', pos: 'center' },
            { target: '#ioControls', title: 'Save & Publish', msg: 'Save your project as JSON, or click the Rocket to publish a standalone game file!', pos: 'bottom' }
        ];

        // start help
        function startTheTutorialThingy() {
            isTheTutorialThingActiveOrNot = true;
            currentStepInTheTutorialThingy = 0;
            document.getElementById('tutorial-overlay').style.display = 'block';
            updateTheTutorialBoxPositionAndText();
        }

        // end help
        function endTheTutorialThingy() {
            isTheTutorialThingActiveOrNot = false;
            document.getElementById('tutorial-overlay').style.display = 'none';
        }

        // next help
        function goToTheNextStepInTutorial() {
            currentStepInTheTutorialThingy++;
            if (currentStepInTheTutorialThingy >= tutorialSteps.length) {
                endTheTutorialThingy();
            } else {
                updateTheTutorialBoxPositionAndText();
            }
        }

        // move box
        function updateTheTutorialBoxPositionAndText() {
            const step = tutorialSteps[currentStepInTheTutorialThingy];
            const target = document.querySelector(step.target);
            if (!target) return; 
            
            if (step.target === '#toolsSection' || step.target === '#settingsSection') {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const rect = target.getBoundingClientRect();
            const spotlight = document.getElementById('spotlight');
            const card = document.getElementById('tutorialCard');

            spotlight.style.left = `${rect.left - 4}px`;
            spotlight.style.top = `${rect.top - 4}px`;
            spotlight.style.width = `${rect.width + 8}px`;
            spotlight.style.height = `${rect.height + 8}px`;

            document.getElementById('tutTitle').innerText = step.title;
            document.getElementById('tutText').innerText = step.msg;
            document.getElementById('tutStep').innerText = `${currentStepInTheTutorialThingy + 1}/${tutorialSteps.length}`;

            const cardW = 300;
            const cardH = 150; 
            let top = rect.bottom + 20;
            let left = rect.left;

            if (step.pos === 'right') {
                left = rect.right + 20;
                top = rect.top;
            } else if (step.pos === 'center') {
                left = window.innerWidth / 2 - 150;
                top = window.innerHeight / 2 - 75;
            } else {
                if (left + cardW > window.innerWidth) left = window.innerWidth - cardW - 20;
            }

            card.style.top = `${top}px`;
            card.style.left = `${left}px`;
        }

        // go
        startTheWholeFreakingEngine();

    </script>
</body>
</html>
